---
title: "Predict Citibike"
output: html_notebook
---

Use the trips_per_day.tsv file that has one row for each day, the number of trips taken on that day, and the minimum temperature on that day.

```{r setup}

library(tidyverse)
library(scales)
library(modelr)
library(lubridate)

theme_set(theme_bw())
options(repr.plot.width=4, repr.plot.height=3)

trips_per_day <- read_tsv('trips_per_day.tsv')

# View(trips_per_day)

```


Split the data into randomly selected training, validation, and test sets, with 80% of the data for training the model, 10% for validation, and 10% for a final test set (to be used once and only once towards the end of this exercise). You can adapt the code from last week's complexity control notebook to do this. You can use a single validation fold, don't worry about k-fold cross-validation here.

```{r model with tmin}

# split data 80-10-10

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]


# r model for each polynomial degree with min temp

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmin <- lm(num_trips ~ poly(tmin, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# r model for a degree 5 polynomial with tmin}

# model for degree 5 polynomial
model_tmin5 <- lm(num_trips ~ poly(tmin, 5, raw=T), data=trips_per_day_train)

# train model
trips_per_day_train <- trips_per_day_train %>%
  add_predictions(model_tmin5) %>%
  mutate(split="train")

# validate model
trips_per_day_validate <- trips_per_day_validate %>%
  add_predictions(model_tmin5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_train, trips_per_day_validate)

ggplot(plot_data, aes(x=tmin, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("Minimum temperature") +
  ylab('Daily trips') +
  scale_y_continuous()


rsquare(model_tmin5, trips_per_day_train)
rsquare(model_tmin5, trips_per_day_validate)

```

RMSE-training data: 5818.522 5816.155 5640.702 5580.913 5555.180 5549.716 5534.182 5531.659
RMSE-validation data: 6390.711 6410.629 6026.563 5797.689 5891.060 5866.693 5973.909 5966.333
R^2-training: 0.7023504
R^2-validation 0.7119241

---------------------------------------------------

---------------------------------------------------

## Model with precipitation

```{r model with precipitation data}

# look at precipitation data

# plot the number of trips as a function of the precipitation

# find the mean, median, and standard deviation of the preciptation
trips_per_day %>%
  summarize(prcp_mean = mean(prcp), prcp_median = median(prcp), prcp_sd = sd(prcp))

trips_per_day %>%
  ggplot(aes(x = prcp, y = num_trips)) +
  geom_point() +
  geom_vline(xintercept = mean(trips_per_day$prcp))

trips_per_day_with_rain <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp))

# View(trips_per_day_with_rain)


# split data with rain 80-10-10}

num_days <- nrow(trips_per_day_with_rain)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_rain_train <- trips_per_day_with_rain[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_rain_validate_and_test <- trips_per_day_with_rain[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_rain_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_rain_validate <- trips_per_day_with_rain_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_rain_test <- trips_per_day_with_rain_validate_and_test[-validation_data, ]


# model for each polynomial degree with min temp and rain}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_prcp <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy, data=trips_per_day_with_rain_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_train) - trips_per_day_with_rain_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_validate) - trips_per_day_with_rain_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with min temp and rain}

# model for degree 5 polynomial
model_prcp5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + too_rainy, data=trips_per_day_with_rain_train)

# train model
trips_per_day_with_rain_train <- trips_per_day_with_rain_train %>%
  add_predictions(model_prcp5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_rain_validate <- trips_per_day_with_rain_validate %>%
  add_predictions(model_prcp5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_rain_train, trips_per_day_with_rain_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips, color=too_rainy)) +
  geom_point() +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)
  

# test the model
test_err <- sqrt(mean((predict(model_prcp5, trips_per_day_with_rain_test) - trips_per_day_with_rain_test$num_trips)^2))
test_err

rsquare(model_prcp5, trips_per_day_with_rain_train)
rsquare(model_prcp5, trips_per_day_with_rain_validate)

```

RMSE-training data: 4883.807 4883.700 4659.654 4614.718 4602.929 4602.908 4600.361 4581.358
RMSE-validation data: 6135.241 6137.263 5860.824 5812.687 5764.039 5762.923 5760.460 5671.854
R^2-training: 0.8046016
R^2-validation 0.6568683

--------------------------------------------------


--------------------------------------------------
## model with weekend

```{r model with tmin and weekend}

# look at whether a day is a weekend

# plot the number of trips as a function of whether or not a day is a weekend
trips_per_day %>%
  ggplot(aes(x = wday(ymd), y = num_trips)) +
  geom_point()

# add a column to the dataframe to indicate if a day is a weekend
trips_per_day_with_weekends <- trips_per_day %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_weekends)


# split data with weekends 80-10-10}

num_days <- nrow(trips_per_day_with_weekends)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_weekends_train <- trips_per_day_with_weekends[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_weekends_validate_and_test <- trips_per_day_with_weekends[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_weekends_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_weekends_validate <- trips_per_day_with_weekends_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_weekends_test <- trips_per_day_with_weekends_validate_and_test[-validation_data, ]


# model for each polynomial degree with min temp and weekends}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_wknd <- lm(num_trips ~ poly(tmin, k, raw=T) + is_weekend, data=trips_per_day_with_weekends_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_train) - trips_per_day_with_weekends_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_validate) - trips_per_day_with_weekends_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with min temp and weekends}

# model for degree 5 polynomial
model_wknd5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + is_weekend, data=trips_per_day_with_weekends_train)

# train model
trips_per_day_with_weekends_train <- trips_per_day_with_weekends_train %>%
  add_predictions(model_wknd5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_weekends_validate <- trips_per_day_with_weekends_validate %>%
  add_predictions(model_wknd5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_weekends_train, trips_per_day_with_weekends_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips, color=is_weekend)) +
  geom_point() +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# test the model
test_err <- sqrt(mean((predict(model_wknd5, trips_per_day_with_weekends_test) - trips_per_day_with_weekends_test$num_trips)^2))
test_err

rsquare(model_wknd5, trips_per_day_with_weekends_train)
rsquare(model_wknd5, trips_per_day_with_weekends_validate)

```

RMSE-training data: 5237.213 5223.024 4993.927 4956.086 4944.749 4941.718 4940.360 4939.695
RMSE-validation data: 5695.495 5703.026 5248.969 5055.391 5121.885 5137.634 5128.177 5138.173
R^2-training: 0.7616406
R^2-validation 0.7545026

--------------------------------------------------


--------------------------------------------------
## Max temp

```{r model with max temp}

# view distribution of max temp

# plot the number of trips as a function of the precipitation
trips_per_day %>%
  ggplot(aes(x = tmax, y = num_trips)) +
  geom_point()


# split data for max temp 80-10-10

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]


# model for each polynomial degree with max temp

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmax <- lm(num_trips ~ poly(tmax, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with tmax

# model for degree 5 polynomial
model_tmax5 <- lm(num_trips ~ poly(tmax, 5, raw=T), data=trips_per_day_train)

# train model
trips_per_day_train <- trips_per_day_train %>%
  add_predictions(model_tmax5) %>%
  mutate(split="train")

# validate model
trips_per_day_validate <- trips_per_day_validate %>%
  add_predictions(model_tmax5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_train, trips_per_day_validate)

ggplot(plot_data, aes(x=tmax, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("Maximum temperature") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# test the model
test_err <- sqrt(mean((predict(model_tmax5, trips_per_day_test) - trips_per_day_test$num_trips)^2))
test_err

rsquare(model_tmax5, trips_per_day_train)
rsquare(model_tmax5, trips_per_day_validate)

```

RMSE-training data: 5504.538 5502.624 5274.098 5180.295 5174.316 5153.984 5152.593 5102.601
RMSE-validation data: 6015.443 6014.945 5868.403 5735.391 5736.544 5677.683 5668.137 5450.804
R^2-training: 0.7488718
R^2-validation 0.6091895

--------------------------------------------------


--------------------------------------------------
# min temp and precipitation and weekends and max temp

```{r model with tmin, prcp, weekends, and tmax}

# create dataframe with all necessary info 

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy + is_weekend + poly(tmax, k, raw=T), data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + too_rainy + is_weekend + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 3849.460 3778.882 3484.953 3407.911 3405.311 3388.749 3385.607 3362.939
RMSE-validation data: 4430.748 4431.258 4597.060 4640.357 4678.735 4582.800 4606.401 4524.926
R^2-training: 0.882134
R^2-validation 0.8115003

--------------------------------------------------


--------------------------------------------------
# min temp and precipitation and weekends and max temp, prcp*weekends

```{r model with tmin, prcp, weekends, tmax and prcp*weekends}

# create dataframe with all necessary info

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info and prcp*weekends

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T), data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with prcp*weekends

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 4152.955 4102.548 3876.223 3802.170 3798.670 3781.614 3768.003 3751.473
RMSE-validation data: 3549.328 3501.741 3538.147 3575.141 3593.700 3543.751 3540.193 3488.610
R^2-training: 0.8576892
R^2-validation 0.8789034


--------------------------------------------------


--------------------------------------------------
# min temp and precipitation and weekends and max temp, prcp*tmin

```{r model with tmin, prcp, weekends, tmax and prcp*tmin}

# create dataframe with all necessary info

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info and prcp*tmin

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmax, k, raw=T) + (too_rainy * tmin) + is_weekend, data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with prcp*tmin

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmax, k, raw=T) + (too_rainy * tmin) + is_weekend, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 4152.955 4102.548 3876.223 3802.170 3798.670 3781.614 3768.003 3751.473
RMSE-validation data: 3549.328 3501.741 3538.147 3575.141 3593.700 3543.751 3540.193 3488.610
R^2-training: 0.8576892
R^2-validation 0.8789034


--------------------------------------------------















































