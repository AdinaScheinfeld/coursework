---
title: "Predict Citibike"
output: html_notebook
---

Use the trips_per_day.tsv file that has one row for each day, the number of trips taken on that day, and the minimum temperature on that day.

```{r setup}

library(tidyverse)
library(scales)
library(modelr)
library(lubridate)

theme_set(theme_bw())
options(repr.plot.width=4, repr.plot.height=3)

trips_per_day <- read_tsv('trips_per_day.tsv')

View(trips_per_day)

```


Split the data into randomly selected training, validation, and test sets, with 80% of the data for training the model, 10% for validation, and 10% for a final test set (to be used once and only once towards the end of this exercise). You can adapt the code from last week's complexity control notebook to do this. You can use a single validation fold, don't worry about k-fold cross-validation here.

```{r split data 80-10-10}

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]

```


Start out with the model in that notebook, which uses only the minimum temperature on each day to predict the number of trips taken that day. Try different polynomial degrees in the minimum temperature and check that you get results similar to what's in that notebook, although they likely won't be identical due to shuffling of which days end up in the train, validation, and test splits. Quantify your performance using root mean-squared error.

```{r model for each polynomial degree with min temp}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmin <- lm(num_trips ~ poly(tmin, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')

```

```{r model for a degree 5 polynomial}

# model for degree 5 polynomial
model_tmin5 <- lm(num_trips ~ poly(tmin, 5, raw=T), data=trips_per_day_train)

# train model
trips_per_day_train <- trips_per_day_train %>%
  add_predictions(model_tmin5) %>%
  mutate(split="train")

# validate model
trips_per_day_validate <- trips_per_day_validate %>%
  add_predictions(model_tmin5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_train, trips_per_day_validate)

ggplot(plot_data, aes(x=tmin, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("Minimum temperature") +
  ylab('Daily trips') +
  scale_y_continuous()

# test the model
test_err <- sqrt(mean((predict(model_tmin5, trips_per_day_test) - trips_per_day_test$num_trips)^2))
test_err

rsquare(model_tmin, trips_per_day_train)
rsquare(model_tmin, trips_per_day_validate)

```



RMSE with min temp:

          RMSE for training error       RMSE for validation error
degree 1:         5623.200                        6086.703
degree 2:         5622.696                        6080.974
degree 3:         5405.370                        6164.553
degree 4:         5317.392                        6216.061
degree 5:         5311.401                        6218.859
degree 6:         5307.016                        6241.981
degree 7:         5306.796                        6236.515
degree 8:         5303.677                        6248.001

R^2               0.7093196                       0.7229095

---------------------------------------------------

## Model with precipitation

```{r look at precipitation data}

# plot the number of trips as a function of the precipitation

# find the mean, median, and standard deviation of the preciptation
trips_per_day %>%
  summarize(prcp_mean = mean(prcp), prcp_median = median(prcp), prcp_sd = sd(prcp))

trips_per_day %>%
  ggplot(aes(x = prcp, y = num_trips)) +
  geom_point() +
  geom_vline(xintercept = 0.1473699)



trips_per_day_with_rain <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp))

View(trips_per_day_with_rain)

```

```{r split data with rain 80-10-10}

num_days <- nrow(trips_per_day_with_rain)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_rain_train <- trips_per_day_with_rain[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_rain_validate_and_test <- trips_per_day_with_rain[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_rain_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_rain_validate <- trips_per_day_with_rain_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_rain_test <- trips_per_day_with_rain_validate_and_test[-validation_data, ]

```

```{r model for each polynomial degree with min temp and rain}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_prcp <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy, data=trips_per_day_with_rain_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_train) - trips_per_day_with_rain_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_validate) - trips_per_day_with_rain_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')

rsquare(model_prcp, trips_per_day_with_rain_train)
rsquare(model_prcp, trips_per_day_with_rain_validate)


```

RMSE with min temp and rain:

          RMSE for training error       RMSE for validation error
degree 1:         4903.669                        5745.404
degree 2:         4897.954                        5782.235
degree 3:         4684.809                        5617.024
degree 4:         4634.298                        5609.840
degree 5:         4632.417                        5574.024
degree 6:         4632.408                        5574.608
degree 7:         4630.670                        5609.968
degree 8:         4623.799                        5554.882

R^2               0.7946171                       0.7128268

--------------------------------------------------

--------------------------------------------------
## model with weekend

```{r look at whether a day is a weekend}

# plot the number of trips as a function of whether or not a day is a weekend
trips_per_day %>%
  ggplot(aes(x = wday(ymd), y = num_trips)) +
  geom_point()

# add a column to the dataframe to indicate if a day is a weekend
trips_per_day_with_weekends <- trips_per_day %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

View(trips_per_day_with_weekends)

```

```{r split data with weekends 80-10-10}

num_days <- nrow(trips_per_day_with_weekends)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_weekends_train <- trips_per_day_with_weekends[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_weekends_validate_and_test <- trips_per_day_with_weekends[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_weekends_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_weekends_validate <- trips_per_day_with_weekends_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_weekends_test <- trips_per_day_with_weekends_validate_and_test[-validation_data, ]

```

```{r model for each polynomial degree with min temp and weekends}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_wknd <- lm(num_trips ~ poly(tmin, k, raw=T) + is_weekend, data=trips_per_day_with_weekends_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_train) - trips_per_day_with_weekends_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_validate) - trips_per_day_with_weekends_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')

rsquare(model_wknd, trips_per_day_with_weekends_train)
rsquare(model_wknd, trips_per_day_with_weekends_validate)


```

RMSE with min temp and weekends:

          RMSE for training error       RMSE for validation error
degree 1:         5378.716                        5958.457
degree 2:         5374.411                        5952.518
degree 3:         5151.637                        5717.204
degree 4:         5085.684                        5635.825
degree 5:         5073.031                        5642.933
degree 6:         5070.532                        5627.316
degree 7:         5056.178                        5707.573
degree 8:         5036.064                        5815.554

R^2               0.7575771                       0.7568155

--------------------------------------------------


--------------------------------------------------
## Max temp

```{r view distribution of max temp}

# plot the number of trips as a function of the precipitation
trips_per_day %>%
  ggplot(aes(x = tmax, y = num_trips)) +
  geom_point()

```

```{r split data for max temp 80-10-10}

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]

```

```{r model for each polynomial degree with max temp}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmax <- lm(num_trips ~ poly(tmax, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')

rsquare(model_tmax, trips_per_day_train)
rsquare(model_tmax, trips_per_day_validate)


```

RMSE with max temp:

          RMSE for training error       RMSE for validation error
degree 1:         5478.886                        5685.638
degree 2:         5475.062                        5746.507
degree 3:         5243.846                        5626.975
degree 4:         5144.283                        5493.232
degree 5:         5138.393                        5466.077
degree 6:         5115.379                        5404.544
degree 7:         5109.276                        5424.168
degree 8:         5052.908                        5325.056

R^2               0.7687446                       0.7047443

--------------------------------------------------


--------------------------------------------------
# min temp and precipitation and weekends and max temp

```{r create dataframe with all necessary info}

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

View(trips_per_day_with_all_info)

```

```{r split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]

```

```{r model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy + is_weekend + poly(tmax, k, raw=T), data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')

```
RMSE with all info:

          RMSE for training error       RMSE for validation error
degree 1:         3926.229                        4171.674
degree 2:         3874.599                        4159.017
degree 3:         3595.014                        3979.491
degree 4:         3521.946                        3844.334
degree 5:         3520.333                        3837.574
degree 6:         3488.706                        3768.791
degree 7:         3473.022                        3778.365
degree 8:         3448.889                        3779.106

```{r model for a degree 3 polynomial}

# model for degree 3 polynomial
model_all3 <- lm(num_trips ~ poly(tmin, 3, raw=T) + too_rainy + is_weekend + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all3) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all3) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all3, trips_per_day_with_all_info_train)
rsquare(model_all3, trips_per_day_with_all_info_validate)


```


```{r model for a degree 4 polynomial}

# model for degree 3 polynomial
model_all4 <- lm(num_trips ~ poly(tmin, 4, raw=T) + too_rainy + is_weekend + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all4) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all4) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all4, trips_per_day_with_all_info_train)
rsquare(model_all4, trips_per_day_with_all_info_validate)


```








--------------------------------------------------
















































