---
title: "Predict Citibike"
output: html_notebook
---

Use the trips_per_day.tsv file that has one row for each day, the number of trips taken on that day, and the minimum temperature on that day.

```{r setup}

library(tidyverse)
library(scales)
library(modelr)
library(lubridate)

theme_set(theme_bw())
options(repr.plot.width=4, repr.plot.height=3)

trips_per_day <- read_tsv('trips_per_day.tsv')

View(trips_per_day)

```


---

## Uses: tmin

```{r model with tmin}

# split data 80-10-10

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]


# r model for each polynomial degree with min temp

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmin <- lm(num_trips ~ poly(tmin, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmin, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# r model for a degree 5 polynomial with tmin}

# model for degree 5 polynomial
model_tmin5 <- lm(num_trips ~ poly(tmin, 5, raw=T), data=trips_per_day_train)

# train model
trips_per_day_train <- trips_per_day_train %>%
  add_predictions(model_tmin5) %>%
  mutate(split="train")

# validate model
trips_per_day_validate <- trips_per_day_validate %>%
  add_predictions(model_tmin5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_train, trips_per_day_validate)

ggplot(plot_data, aes(x=tmin, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("Minimum temperature") +
  ylab('Daily trips') +
  scale_y_continuous()


rsquare(model_tmin5, trips_per_day_train)
rsquare(model_tmin5, trips_per_day_validate)

```

RMSE-training data: 5818.522 5816.155 5640.702 5580.913 5555.180 5549.716 5534.182 5531.659
RMSE-validation data: 6390.711 6410.629 6026.563 5797.689 5891.060 5866.693 5973.909 5966.333
R^2-training: 0.7023504
R^2-validation 0.7119241

---


---

## Uses: tmin, too_rainy

```{r model with tmin and too_rainy}

# look at precipitation data

# plot the number of trips as a function of the precipitation

# find the mean, median, and standard deviation of the preciptation
trips_per_day %>%
  summarize(prcp_mean = mean(prcp), prcp_median = median(prcp), prcp_sd = sd(prcp))

trips_per_day %>%
  ggplot(aes(x = prcp, y = num_trips)) +
  geom_point() +
  geom_vline(xintercept = mean(trips_per_day$prcp))

trips_per_day_with_rain <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp))

# View(trips_per_day_with_rain)


# split data with rain 80-10-10}

num_days <- nrow(trips_per_day_with_rain)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_rain_train <- trips_per_day_with_rain[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_rain_validate_and_test <- trips_per_day_with_rain[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_rain_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_rain_validate <- trips_per_day_with_rain_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_rain_test <- trips_per_day_with_rain_validate_and_test[-validation_data, ]


# model for each polynomial degree with min temp and rain}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_prcp <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy, data=trips_per_day_with_rain_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_train) - trips_per_day_with_rain_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_prcp, trips_per_day_with_rain_validate) - trips_per_day_with_rain_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with min temp and rain}

# model for degree 5 polynomial
model_prcp5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + too_rainy, data=trips_per_day_with_rain_train)

# train model
trips_per_day_with_rain_train <- trips_per_day_with_rain_train %>%
  add_predictions(model_prcp5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_rain_validate <- trips_per_day_with_rain_validate %>%
  add_predictions(model_prcp5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_rain_train, trips_per_day_with_rain_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips, color=too_rainy)) +
  geom_point() +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=too_rainy)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)
  

# test the model
test_err <- sqrt(mean((predict(model_prcp5, trips_per_day_with_rain_test) - trips_per_day_with_rain_test$num_trips)^2))
test_err

rsquare(model_prcp5, trips_per_day_with_rain_train)
rsquare(model_prcp5, trips_per_day_with_rain_validate)

```

RMSE-training data: 4883.807 4883.700 4659.654 4614.718 4602.929 4602.908 4600.361 4581.358
RMSE-validation data: 6135.241 6137.263 5860.824 5812.687 5764.039 5762.923 5760.460 5671.854
R^2-training: 0.8046016
R^2-validation 0.6568683

--------------------------------------------------


--------------------------------------------------
## Uses: tmin, is_weekend

```{r model with tmin and is_weekend}

# look at whether a day is a weekend

# plot the number of trips as a function of whether or not a day is a weekend
trips_per_day %>%
  ggplot(aes(x = wday(ymd), y = num_trips)) +
  geom_point()

# add a column to the dataframe to indicate if a day is a weekend
trips_per_day_with_weekends <- trips_per_day %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_weekends)


# split data with weekends 80-10-10}

num_days <- nrow(trips_per_day_with_weekends)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_weekends_train <- trips_per_day_with_weekends[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_weekends_validate_and_test <- trips_per_day_with_weekends[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_weekends_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_weekends_validate <- trips_per_day_with_weekends_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_weekends_test <- trips_per_day_with_weekends_validate_and_test[-validation_data, ]


# model for each polynomial degree with min temp and weekends}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_wknd <- lm(num_trips ~ poly(tmin, k, raw=T) + is_weekend, data=trips_per_day_with_weekends_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_train) - trips_per_day_with_weekends_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_wknd, trips_per_day_with_weekends_validate) - trips_per_day_with_weekends_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with min temp and weekends}

# model for degree 5 polynomial
model_wknd5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + is_weekend, data=trips_per_day_with_weekends_train)

# train model
trips_per_day_with_weekends_train <- trips_per_day_with_weekends_train %>%
  add_predictions(model_wknd5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_weekends_validate <- trips_per_day_with_weekends_validate %>%
  add_predictions(model_wknd5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_weekends_train, trips_per_day_with_weekends_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips, color=is_weekend)) +
  geom_point() +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# test the model
test_err <- sqrt(mean((predict(model_wknd5, trips_per_day_with_weekends_test) - trips_per_day_with_weekends_test$num_trips)^2))
test_err

rsquare(model_wknd5, trips_per_day_with_weekends_train)
rsquare(model_wknd5, trips_per_day_with_weekends_validate)

```

RMSE-training data: 5237.213 5223.024 4993.927 4956.086 4944.749 4941.718 4940.360 4939.695
RMSE-validation data: 5695.495 5703.026 5248.969 5055.391 5121.885 5137.634 5128.177 5138.173
R^2-training: 0.7616406
R^2-validation 0.7545026

--------------------------------------------------


--------------------------------------------------
## Uses: tmax

```{r model with tmax}

# view distribution of max temp

# plot the number of trips as a function of the precipitation
trips_per_day %>%
  ggplot(aes(x = tmax, y = num_trips)) +
  geom_point()


# split data for max temp 80-10-10

num_days <- nrow(trips_per_day)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_train <- trips_per_day[training_data, ]

# used to evaluate the fit and test
trips_per_day_validate_and_test <- trips_per_day[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_validate <- trips_per_day_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_test <- trips_per_day_validate_and_test[-validation_data, ]


# model for each polynomial degree with max temp

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
  # fit on the training data
  model_tmax <- lm(num_trips ~ poly(tmax, k, raw=T), data=trips_per_day_train)
  
  # evaluate on the training data
  train_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_train) - trips_per_day_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_tmax, trips_per_day_validate) - trips_per_day_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with tmax

# model for degree 5 polynomial
model_tmax5 <- lm(num_trips ~ poly(tmax, 5, raw=T), data=trips_per_day_train)

# train model
trips_per_day_train <- trips_per_day_train %>%
  add_predictions(model_tmax5) %>%
  mutate(split="train")

# validate model
trips_per_day_validate <- trips_per_day_validate %>%
  add_predictions(model_tmax5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_train, trips_per_day_validate)

ggplot(plot_data, aes(x=tmax, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("Maximum temperature") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# test the model
test_err <- sqrt(mean((predict(model_tmax5, trips_per_day_test) - trips_per_day_test$num_trips)^2))
test_err

rsquare(model_tmax5, trips_per_day_train)
rsquare(model_tmax5, trips_per_day_validate)

```

RMSE-training data: 5504.538 5502.624 5274.098 5180.295 5174.316 5153.984 5152.593 5102.601
RMSE-validation data: 6015.443 6014.945 5868.403 5735.391 5736.544 5677.683 5668.137 5450.804
R^2-training: 0.7488718
R^2-validation 0.6091895

--------------------------------------------------


--------------------------------------------------
# Uses: tmin, too_rainy, is_weekend, tmax

```{r model with tmin, too_rainy, is_weekend, and tmax}

# create dataframe with all necessary info 

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy + is_weekend + poly(tmax, k, raw=T), data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + too_rainy + is_weekend + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 3849.460 3778.882 3484.953 3407.911 3405.311 3388.749 3385.607 3362.939
RMSE-validation data: 4430.748 4431.258 4597.060 4640.357 4678.735 4582.800 4606.401 4524.926
R^2-training: 0.882134
R^2-validation 0.8115003

--------------------------------------------------


--------------------------------------------------
# Uses: tmin, tmax, (too_rainy * is_weekend)

```{r model with tmin, tmax, and (too_rainy * is_weekend)}

# create dataframe with all necessary info

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info and prcp*weekends

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T), data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with prcp*weekends

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 4152.955 4102.548 3876.223 3802.170 3798.670 3781.614 3768.003 3751.473
RMSE-validation data: 3549.328 3501.741 3538.147 3575.141 3593.700 3543.751 3540.193 3488.610
R^2-training: 0.8576892
R^2-validation 0.8789034

--------------------------------------------------


--------------------------------------------------
# Uses: tmax, is_weekend, (too_rainy * tmin)

```{r model with tmax, is_weekend, and (too_rainy * tmin)}

# create dataframe with all necessary info

trips_per_day_with_all_info <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7))

# View(trips_per_day_with_all_info)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_validate_and_test <- trips_per_day_with_all_info[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_test <- trips_per_day_with_all_info_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info and prcp*tmin

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmax, k, raw=T) + (too_rainy * tmin) + is_weekend, data=trips_per_day_with_all_info_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_train) - trips_per_day_with_all_info_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_validate) - trips_per_day_with_all_info_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial with prcp*tmin

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmax, k, raw=T) + (too_rainy * tmin) + is_weekend, data=trips_per_day_with_all_info_train)

# train model
trips_per_day_with_all_info_train <- trips_per_day_with_all_info_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_validate <- trips_per_day_with_all_info_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_train, trips_per_day_with_all_info_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_train)
rsquare(model_all5, trips_per_day_with_all_info_validate)

```

RMSE-training data: 4152.955 4102.548 3876.223 3802.170 3798.670 3781.614 3768.003 3751.473
RMSE-validation data: 3549.328 3501.741 3538.147 3575.141 3593.700 3543.751 3540.193 3488.610
R^2-training: 0.8576892
R^2-validation 0.8789034

--------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, too_rainy, is_weekend, is_holiday

```{r model with tmin, tmax, too_rainy, is_weekend, and is_holiday}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + too_rainy + is_weekend + poly(tmax, k, raw=T) + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + too_rainy + is_weekend + tmax + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3784.673 3749.215 3537.594 3481.565 3476.052 3431.611 3430.712 3378.070
RMSE-validation data: 3803.170 3671.559 3726.839 3572.385 3602.205 3768.977 3814.995 5152.072
R^2-training: 0.8792362
R^2-validation 0.8800654

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, is_holiday, (too_rainy * is_weekend) duplicate

```{r model with tmin, tmax, is_holiday, (too_rainy * is_weekend) duplicate}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T) + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3804.925 3750.448 3494.155 3424.734 3423.072 3383.482 3381.620 3364.489
RMSE-validation data: 3339.360 3241.006 2922.803 3045.268 3043.108 3061.744 3085.516 3112.569
R^2-training: 0.8776939
R^2-validation 0.9253191

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, is_weekend, (too_rainy * is_holiday)

```{r model with tmin, tmax, is_weekend, (too_rainy * is_holiday)}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + is_weekend + poly(tmax, k, raw=T) + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + is_weekend + tmax + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3755.117 3720.175 3487.001 3421.821 3414.605 3372.721 3369.654 3339.024
RMSE-validation data: 3696.049 3651.904 3755.974 3581.442 3618.071 3780.168 3862.291 3629.705
R^2-training: 0.8864092
R^2-validation 0.8933994

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, (too_rainy * is_weekend), (too_rainy * is_holiday)

```{r model with tmin, tmax, (too_rainy * is_weekend), (too_rainy * is_holiday)}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T) + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3702.393 3648.454 3449.120 3390.327 3384.632 3326.915 3322.878 3273.360
RMSE-validation data: 4609.239 4645.789 4447.704 4361.282 4388.688 4543.247 4564.056 4559.495
R^2-training: 0.8850524
R^2-validation 0.8420684

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, is_holiday, (too_rainy * is_weekend)

```{r model with tmin, tmax, is_holiday, (too_rainy * is_weekend)}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T) + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3804.925 3750.448 3494.155 3424.734 3423.072 3383.482 3381.620 3364.489
RMSE-validation data: 3339.360 3241.006 2922.803 3045.268 3043.108 3061.744 3085.516 3112.569
R^2-training: 0.8776939
R^2-validation 0.9253191

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, is_weekend, too_rainy, (too_rainy * is_holiday)

```{r model with tmin, tmax, is_weekend, too_rainy, (too_rainy * is_holiday)}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
model_all <- lm(num_trips ~ poly(tmin, k, raw=T) + is_weekend + poly(tmax, k, raw=T) + too_rainy + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(model_all, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
model_all5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + is_weekend + tmax + too_rainy + (too_rainy * is_holiday), data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(model_all5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(model_all5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(model_all5, trips_per_day_with_all_info_and_holidays_train)
rsquare(model_all5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3732.388 3652.815 3489.255 3438.562 3422.553 3399.908 3396.579 3355.628
RMSE-validation data: 4369.512 4589.837 4089.246 3883.693 4009.928 3949.853 3945.395 4094.982
R^2-training: 0.8805983
R^2-validation 0.8678042

-------------------------------------------------


--------------------------------------------------

## Uses tmin, tmax, is_holiday, (too_rainy * is_weekend) **best model**

```{r best model with tmin, tmax, is_holiday, (too_rainy * is_weekend)}

# read in holiday file
us_bank_holidays <- read_csv('US_Bank_holidays.csv', col_names = c("number", "ymd", "name"))
#View(us_bank_holidays)


# create dataframe with all necessary info and join trips data with holiday data

trips_per_day_with_all_info_and_holidays <- trips_per_day %>% 
  mutate(too_rainy = prcp > mean(prcp)) %>% 
  mutate(is_weekend = wday(ymd) %in% c(1,7)) %>%
  left_join(us_bank_holidays, by = "ymd") %>%
  rename(holiday_name = name) %>%
  mutate(is_holiday = !is.na(holiday_name)) %>%
  select(ymd, num_trips, tmax, tmin, too_rainy, is_weekend, is_holiday)

View(trips_per_day_with_all_info_and_holidays)


# split data with all info 80-10-10}

num_days <- nrow(trips_per_day_with_all_info_and_holidays)
frac_train <- 0.8
num_train <- floor(num_days * frac_train)

# randomly sample rows for the training set
training_data <- sample(1:num_days, num_train, replace=F)

# used to fit the model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays[training_data, ]

# used to evaluate the fit and test
trips_per_day_with_all_info_and_holidays_validate_and_test <- trips_per_day_with_all_info_and_holidays[-training_data, ]

num_days_in_validate_and_test <-nrow(trips_per_day_with_all_info_and_holidays_validate_and_test)
frac_validate <- 0.5
num_validate <- floor(num_days_in_validate_and_test * frac_validate)

# randomly sample rows for the validation set
validation_data <- sample(1:num_days_in_validate_and_test, num_validate, replace=F) 

# used to validate the model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate_and_test[validation_data, ]

# used to test the model
trips_per_day_with_all_info_and_holidays_test <- trips_per_day_with_all_info_and_holidays_validate_and_test[-validation_data, ]


# model for each polynomial degree with all info}

K <- 1:8

train_err <- c()
validate_err <- c()

for (k in K) {
  
# fit on the training data
best_model <- lm(num_trips ~ poly(tmin, k, raw=T) + (too_rainy * is_weekend) + poly(tmax, k, raw=T) + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)
  
# evaluate on the training data
train_err[k] <- sqrt(mean((predict(best_model, trips_per_day_with_all_info_and_holidays_train) - trips_per_day_with_all_info_and_holidays_train$num_trips)^2))
  
  # evaluate on the validate data
  validate_err[k] <- sqrt(mean((predict(best_model, trips_per_day_with_all_info_and_holidays_validate) - trips_per_day_with_all_info_and_holidays_validate$num_trips)^2))
}

train_err
validate_err

# plot the training and validation error as a function of polynomial degree

plot_data <- data.frame(K, train_err, validate_err) %>%
  gather("split", "error", -K)

ggplot(plot_data, aes(x=K, y=error, color=split)) +
  geom_line() +
  scale_x_continuous(breaks=K) +
  xlab('Polynomial Degree') +
  ylab('RMSE')


# model for a degree 5 polynomial}

# model for degree 5 polynomial
best_model5 <- lm(num_trips ~ poly(tmin, 5, raw=T) + (too_rainy * is_weekend) + tmax + is_holiday, data=trips_per_day_with_all_info_and_holidays_train)

# train model
trips_per_day_with_all_info_and_holidays_train <- trips_per_day_with_all_info_and_holidays_train %>%
  add_predictions(best_model5) %>%
  mutate(split="train")

# validate model
trips_per_day_with_all_info_and_holidays_validate <- trips_per_day_with_all_info_and_holidays_validate %>%
  add_predictions(best_model5) %>%
  mutate(split="validate")

# plot the training data and validation data with the model
plot_data <- bind_rows(trips_per_day_with_all_info_and_holidays_train, trips_per_day_with_all_info_and_holidays_validate)

ggplot(plot_data, aes(x=ymd, y=num_trips)) +
  geom_point(aes(color=split)) +
  geom_line(aes(y=pred)) +
  xlab("YMD") +
  ylab('Daily trips') +
  scale_y_continuous()

# plot with actual vs. predicted
ggplot(plot_data, aes(x=pred, y=num_trips, color=split)) +
  geom_point() +
  geom_abline() +
  scale_x_continuous("Predicted Number of Trips", label=comma) +
  scale_y_continuous("Actual Number of Trips", label=comma)

# find R^2 values

rsquare(best_model5, trips_per_day_with_all_info_and_holidays_train)
rsquare(best_model5, trips_per_day_with_all_info_and_holidays_validate)

```

RMSE-training data: 3778.722 3721.948 3515.101 3432.310 3430.596 3396.907 3393.529 3349.031
RMSE-validation data: 4466.539 4374.817 3937.105 3905.444 3884.323 3986.518 4097.692 4305.481
R^2-training: 0.8834531
R^2-validation 0.877956

```{r}

# evaluate on the test data
test_err <- sqrt(mean((predict(best_model, trips_per_day_with_all_info_and_holidays_test) - trips_per_day_with_all_info_and_holidays_test$num_trips)^2))

test_err


# find R^2 value
rsquare(best_model5, trips_per_day_with_all_info_and_holidays_test)

```

### Outcome when using the test data:

RMSE: 2792.312
R^2: 0.9102012

Based on these numbers, I think my model will perform well on future data.
I think it will do slightly worse than it did on the 10% test that I used here, because the future data will be
from a different year than the training and validation data, and the 10% test data was from the same year. 

-------------------------------------------------









































